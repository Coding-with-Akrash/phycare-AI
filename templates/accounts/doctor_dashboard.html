{% extends "base.html" %}

{% block title %}Doctor Dashboard - PsyCare AI{% endblock %}

{% block extra_css %}
<style>
.analytics-section {
    background: linear-gradient(145deg, #f8fafc, #f1f5f9);
    padding: 60px 0;
    margin: 40px 0;
}

.chart-container {
    position: relative;
    height: 400px;
    margin: 20px 0;
}

.patient-card {
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-color);
}

.patient-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.emotion-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    margin: 2px;
}

.emotion-text { background: #3b82f6; color: white; }
.emotion-facial { background: #10b981; color: white; }
</style>
{% endblock %}

{% block content %}
<!-- Enhanced Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <div class="row align-items-center">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="hero-title pulse">Welcome, Dr. {{ user.first_name|default:user.username }}!</h1>
                    <p class="hero-subtitle">
                        Professional healthcare platform for managing your patients, appointments, and medical records securely.
                    </p>
                    <div class="mt-3">
                        <button onclick="history.back()" class="btn btn-outline-light btn-lg me-2">
                            <i class="fas fa-arrow-left me-2"></i>Back
                        </button>
                        <a href="{% url 'logout' %}" class="btn btn-outline-light btn-lg pulse">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Enhanced Dashboard Content -->
<div class="container my-5">
    <!-- Quick Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-number">{{ user.profile.experience_years|default:5 }}+</div>
                <div class="stat-label">Years Experience</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-number">{{ user.profile.specialization|default:"General" }}</div>
                <div class="stat-label">Specialization</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-number">127</div>
                <div class="stat-label">Active Patients</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-number">45</div>
                <div class="stat-label">This Week</div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Professional Profile -->
        <div class="col-md-6 mb-4">
            <div class="card card-premium">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h4 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>
                        Professional Profile
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <small class="text-muted">Name</small>
                                <p class="mb-2 fw-bold">{{ user.get_full_name|default:user.username }}</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Email</small>
                                <p class="mb-2">{{ user.email }}</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Specialization</small>
                                <p class="mb-2 fw-bold" style="color: var(--primary-color);">
                                    {{ user.profile.specialization|default:"Not specified" }}
                                </p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">License Number</small>
                                <p class="mb-2">{{ user.profile.license_number|default:"Not provided" }}</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Experience</small>
                                <p class="mb-2">{{ user.profile.experience_years|default:0 }} years</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Hospital/Clinic</small>
                                <p class="mb-2">{{ user.profile.hospital_clinic|default:"Not specified" }}</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Member Since</small>
                                <p class="mb-2">{{ user.date_joined|date:"F j, Y" }}</p>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-success">Active Doctor</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="col-md-6 mb-4">
            <div class="card card-premium">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h4 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-tasks me-2" style="color: var(--accent-color);"></i>
                        Quick Actions
                    </h4>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <button class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-calendar-plus me-2"></i>View Appointments
                        </button>
                        <button class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-users me-2"></i>Manage Patients
                        </button>
                        <button class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-file-medical me-2"></i>Medical Records
                        </button>
                        <button class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-chart-line me-2"></i>Analytics
                        </button>
                        <button class="btn btn-primary btn-lg">
                            <i class="fas fa-edit me-2"></i>Edit Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity & Upcoming -->
    <div class="row">
        <!-- Recent Activity -->
        <div class="col-md-6 mb-4">
            <div class="card card-elevated">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h4 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>
                        Recent Activity
                    </h4>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">New patient appointment</h6>
                                <p class="mb-0 text-muted">Sarah Johnson - General Checkup</p>
                            </div>
                            <small class="text-muted">2 hours ago</small>
                        </div>
                        <hr class="my-2">
                        <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Medical record updated</h6>
                                <p class="mb-0 text-muted">Michael Brown - Prescription updated</p>
                            </div>
                            <small class="text-muted">4 hours ago</small>
                        </div>
                        <hr class="my-2">
                        <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">New patient registered</h6>
                                <p class="mb-0 text-muted">Emily Davis</p>
                            </div>
                            <small class="text-muted">1 day ago</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upcoming Schedule -->
        <div class="col-md-6 mb-4">
            <div class="card card-elevated">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h4 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-calendar me-2" style="color: var(--accent-color);"></i>
                        Upcoming Schedule
                    </h4>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Sarah Johnson</h6>
                                <p class="mb-0 text-muted">General Checkup</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Today, 2:00 PM</small><br>
                                <span class="badge bg-success">Confirmed</span>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Michael Brown</h6>
                                <p class="mb-0 text-muted">Follow-up</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Tomorrow, 10:30 AM</small><br>
                                <span class="badge bg-warning">Pending</span>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Emily Davis</h6>
                                <p class="mb-0 text-muted">Consultation</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Dec 12, 3:45 PM</small><br>
                                <span class="badge bg-primary">Scheduled</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Multimodal Patient Analytics Section -->
    <div class="analytics-section">
        <div class="container">
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h2 class="mb-3" style="color: var(--primary-color); font-weight: 700;">Multimodal Patient Analytics</h2>
                    <p class="text-muted">Comprehensive insights combining text-based emotions, facial expressions, and mental health assessments</p>
                </div>
            </div>

            <!-- Analytics Overview Cards -->
            <div class="row mb-4">
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ analytics_data.total_patients }}</div>
                        <div class="stat-label">Active Patients</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ analytics_data.total_appointments }}</div>
                        <div class="stat-label">Total Appointments</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ analytics_data.recent_appointments|length }}</div>
                        <div class="stat-label">Recent Sessions</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">95%</div>
                        <div class="stat-label">Assessment Rate</div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-5">
                <!-- Emotion Distribution Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="card card-premium">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h4 class="mb-0 d-flex align-items-center">
                                <i class="fas fa-chart-pie me-2" style="color: var(--primary-color);"></i>
                                Emotion Distribution (Text vs Facial)
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="emotionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mental Health Trends Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="card card-premium">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h4 class="mb-0 d-flex align-items-center">
                                <i class="fas fa-chart-line me-2" style="color: var(--accent-color);"></i>
                                Mental Health Trends (Last 30 Days)
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="trendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Progress Overview -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-elevated">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h4 class="mb-0 d-flex align-items-center">
                                <i class="fas fa-users me-2" style="color: var(--primary-color);"></i>
                                Patient Progress & Detailed Assessments
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for patient in patients %}
                                <div class="col-lg-6 mb-4">
                                    <div class="card patient-card">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ patient.user.first_name }} {{ patient.user.last_name }}</h5>
                                            <p class="text-muted mb-3">Age: {{ patient.age }} | Gender: {{ patient.gender }}</p>

                                            <!-- Latest Assessment -->
                                            {% with latest_quiz=patient.user.mentalhealthquiz_set.last %}
                                            {% if latest_quiz %}
                                            <div class="mb-3">
                                                <h6 class="text-primary">Latest Assessment ({{ latest_quiz.created_at|date:"M d, Y" }})</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <small class="text-muted">Depression</small>
                                                        <div class="fw-bold text-capitalize">{{ latest_quiz.depression_level }}</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">Anxiety</small>
                                                        <div class="fw-bold text-capitalize">{{ latest_quiz.anxiety_level }}</div>
                                                    </div>
                                                </div>
                                                {% if latest_quiz.facial_emotion_data %}
                                                <div class="mt-2">
                                                    <small class="text-muted">Facial Analysis:</small>
                                                    <span class="emotion-badge emotion-facial">Available</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% endwith %}

                                            <!-- Recent Emotions -->
                                            {% with recent_chat=patient.user.chatlog_set.last %}
                                            {% if recent_chat %}
                                            <div class="mb-3">
                                                <h6 class="text-accent">Recent Chat Emotions</h6>
                                                <span class="emotion-badge emotion-text">{{ recent_chat.emotion }}</span>
                                                {% if recent_chat.facial_emotion_data %}
                                                <span class="emotion-badge emotion-facial">{{ recent_chat.facial_emotion.primary_emotion|default:"Detected" }}</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% endwith %}

                                            <!-- Recommendations -->
                                            {% with latest_quiz=patient.user.mentalhealthquiz_set.last %}
                                            {% if latest_quiz and latest_quiz.recommendations %}
                                            <div class="mb-3">
                                                <h6 class="text-warning">Key Recommendations</h6>
                                                <ul class="list-unstyled small">
                                                    {% for rec in latest_quiz.recommendations|slice:":2" %}
                                                    <li><i class="fas fa-check-circle text-success me-2"></i>{{ rec }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                            {% endwith %}

                                            <button class="btn btn-outline-primary btn-sm" onclick="viewPatientDetails({{ patient.id }})">
                                                <i class="fas fa-eye me-1"></i>View Full Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12 text-center">
                                    <p class="text-muted">No patients with appointments found.</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parse chart data from Django context
    const chartData = JSON.parse('{{ chart_data|escapejs }}');

    // Emotion Distribution Chart
    const emotionCtx = document.getElementById('emotionChart').getContext('2d');
    new Chart(emotionCtx, {
        type: 'doughnut',
        data: {
            labels: [
                ...Object.keys(chartData.emotion_distribution.text_emotions || {}),
                ...Object.keys(chartData.emotion_distribution.facial_emotions || {})
            ],
            datasets: [{
                label: 'Text Emotions',
                data: Object.values(chartData.emotion_distribution.text_emotions || {}),
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6b7280'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: 'Combined Text & Facial Emotion Analysis'
                }
            }
        }
    });

    // Mental Health Trends Chart
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: chartData.quiz_trends.dates || [],
            datasets: [{
                label: 'Depression Level',
                data: (chartData.quiz_trends.depression || []).map(d => {
                    const levels = {'minimal': 1, 'mild': 2, 'moderate': 3, 'moderately_severe': 4, 'severe': 5};
                    return levels[d.level] || 0;
                }),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Anxiety Level',
                data: (chartData.quiz_trends.anxiety || []).map(d => {
                    const levels = {'minimal': 1, 'mild': 2, 'moderate': 3, 'moderately_severe': 4, 'severe': 5};
                    return levels[d.level] || 0;
                }),
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        callback: function(value) {
                            const labels = ['', 'Minimal', 'Mild', 'Moderate', 'Mod. Severe', 'Severe'];
                            return labels[value] || value;
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Mental Health Assessment Trends'
                }
            }
        }
    });
});

function viewPatientDetails(patientId) {
    // Implement patient detail view - could redirect to a detailed patient page
    alert('Patient detail view for ID: ' + patientId + ' (Feature to be implemented)');
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
